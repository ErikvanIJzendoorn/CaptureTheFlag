{% block toernooi_info %}
    <div class="info_container">
        <div>
           <div id="myProgress">
              <div id="myBar"></div>
           </div>
        </div>
        <div class="text-container">
            <p id="float-left">
                <span class="fa fa-eye"></span> = Vraag wordt nagekeken door een scheidsrechter
            </p>
            <h5 id="float-right">
                Ronde: {{ current_round }}
            </h5>
        </div>
    </div>
{% endblock %}

<script>

    const progress = (function ($) {
        let bar = null;
        let barPos = 0;
        let questionElements = null;
        let enabled = true;
        let round = 0;
        const hrefs = [];

        const init = function () {
            bar = $('#myBar');
            timer = $('#timer');
            questionElements = $('.question-btn');
            questionContainers = $('.question');
            update();
            setInterval(update, 1000);
        }

        const update = function () {
            $.ajax({
                'url': '/dashboard/timer/{{ id }}',
                'dataType': 'json',
                'async': true,
                'success': function (data) {
                    calculateBar(data);
                    calculateTime(data);
                    if (round != 0) {
                        if (data.round != round) {
                            location.reload();
                        }
                    }

                    round = data.round
                }
            });
        }

        const disableQuestions = function () {
            if (enabled) {
                for (let i = 0; i < questionElements.length; i++) {
                    hrefs.push(questionElements[i].href);
                    questionElements[i].href = '#';
                    questionContainers[i].classList.add('question-disabled');
                    questionElements[i].classList.add('question-disabled');
                }
                enabled = !enabled;

                setTimeout(function () {
                    //location.reload();
                }, 1000)
            }
        }

        const enableQuestions = function () {
            if (!enabled) {
                for (let i = 0; i < questionElements.length; i++) {
                    questionElements[i].href = hrefs.shift();
                    questionContainers[i].classList.remove('question-disabled');
                    questionElements[i].classList.remove('question-disabled');
                }
                enabled = !enabled;
            }
        }

        const calculateBar = function (clock) {
            if (clock.active == 1) {
                const starttime = new Date(Date.parse(clock.start_time));
                const endtime = new Date(Date.parse(clock.endtime));

                range = endtime - starttime;
                diff = Math.max(0, endtime - new Date());

                barPos = (100 - 100 * diff / range);

                bar.css('background-color', 'green');
            }
            else {
                barPos = 100;
                bar.css('background-color', 'maroon');
            }

            setBar(barPos);
        }

        const calculateTime = function (clock) {
            if (clock.active == 1) {
                enableQuestions();
                endtime = new Date(Date.parse(clock.endtime));
                now = Date.now();

                diffInSec = Math.round((endtime - now) / 1000);

                timeLeft = new Date(diffInSec * 1000).toISOString().substr(11, 8);
            }
            else {
                disableQuestions();
                if (clock.set == 1) {
                    const current_timer_time = clock.current_timer_time;
                    timeLeft = current_timer_time.substr(0, 8) + "<i> - Pauze</i>";
                }
                else {
                    timeLeft = "00:00:00";
                }
            }
                
            timer.html(timeLeft);
        }

        const setBar = function (percentage) {
            bar.css('width', percentage + '%');
        }

        return {
            init: init
        }

    })(jQuery);

    $(function () {
        progress.init();
    });

</script>

<style>
    #myBar {
        transition: .5s;
    }

    .question-disabled {
        background-color: #222222;
        cursor: default;
    }

        .question-disabled:hover {
            text-decoration: none;
        }
</style>
